#!/usr/bin/env ruby
#
# = BioRuby shell - command line interface for the BioRuby library
#
# Copyright::   Copyright (C) 2005, 2006
#               Toshiaki Katayama <k@bioruby.org>
# License::     Ruby's
#
# $Id: bioruby,v 1.12 2006/02/09 20:17:03 k Exp $
#

begin
  require 'rubygems'
  require_gem 'bio', '~> 0.7'
rescue LoadError
end

require 'bio/shell'

include Bio::Shell

### Command line argument

# working directory or script file
if arg = ARGV.shift
  if File.directory?(arg)
    # directory or symlink to directory
    Dir.chdir(arg)
  elsif File.exists?(arg)
    # BioRuby shell script (lib/bioruby.rb can be obsolete)
    load arg
    exit
  elsif arg
    Dir.mkdir(arg)
    Dir.chdir(arg)
  end
end

### BioRuby shell setup

# loading configuration and plugins
Bio::Shell.setup

### IRB setup

require 'irb'
begin
  require 'irb/completion'
  Bio::Shell.cache[:readline] = true
rescue LoadError
  Bio::Shell.cache[:readline] = false
end

IRB.setup(nil)

# set application name
IRB.conf[:AP_NAME] = 'bioruby'

# change prompt for bioruby
$_ = Bio::Shell.esc_seq
IRB.conf[:PROMPT][:BIORUBY_COLOR] = {
  :PROMPT_I => "bio#{$_[:ruby]}ruby#{$_[:none]}> ",
  :PROMPT_S => "bio#{$_[:ruby]}ruby#{$_[:none]}%l ",
  :PROMPT_C => "bio#{$_[:ruby]}ruby#{$_[:none]}+ ",
  :RETURN   => "  ==> %s\n"
}
IRB.conf[:PROMPT][:BIORUBY] = {
  :PROMPT_I => "bioruby> ",
  :PROMPT_S => "bioruby%l ",
  :PROMPT_C => "bioruby+ ",
  :RETURN   => "  ==> %s\n"
}
if Bio::Shell.config[:color]
  IRB.conf[:PROMPT_MODE] = :BIORUBY_COLOR
else
  IRB.conf[:PROMPT_MODE] = :BIORUBY
end
IRB.conf[:ECHO] = Bio::Shell.config[:echo] || false

# irb/input-method.rb >= v1.5 (not in 1.8.2)
#IRB.conf[:SAVE_HISTORY] = 100000

# not beautifully works
#IRB.conf[:AUTO_INDENT] = true

### IRB main loop

irb = IRB::Irb.new

# needed for method completion
IRB.conf[:MAIN_CONTEXT] = irb.context

# loading workspace and command history
Bio::Shell.load

Signal.trap("SIGINT") do
  irb.signal_handle
end

catch(:IRB_EXIT) do
  irb.eval_input
end

# saving workspace, command history and configuration before exit
Bio::Shell.save

